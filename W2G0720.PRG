* Program Name: W2G0720
* Author:       David M. Wysocki
* Company:      Diversified Technical Service, Inc.
* Client:       Palm Beach Kennal Club
* Purpose:      Database Error Reporting - Unmatched TICKET records.
*
*
FUNCTION W2G0720()

MEMVAR GETLIST
SET ESCAPE ON
SET SAFETY OFF

M->L_NUMBER = 0
M->P_NUMBER = 0
M->REC_ID   = SPACE(9)
M->BTCH_DT  = DATE()
M->BTCH_NUM = 0
M->GROSS    = 0.00
M->FED_WITH = 0.00
M->DATE_WON = DATE()
M->TRANS    = SPACE(10)
M->RACE     = 0
M->WINNINGS = SPACE(10)
M->CASHIER  = 0
M->WINDOW   = 0
M->TIME     = SPACE(8)

CLEAR

SELECT 1
USE TICKET
SET INDEX TO TICKET

SELECT 2
USE PAYEE
SET INDEX TO PAYEE

SELECT 3
USE RPT0720

CLEAR
@ 0,10 SAY 'DATABASE ERROR REPORT - UNMATCHED TICKET RECORDS.'
@ 2,10 SAY '1 - RE-PRINT PREVIOUS ERROR REPORT.'
@ 4,10 SAY '2 - CREATE NEW REPORT. OLD REPORT WILL BE DELETED.'
@ 6,10 SAY '3 - EXIT REPORT.'

M->CHOICE = ' '

DO WHILE .NOT. M->CHOICE $'123'
   M->CHOICE = ' '
   @ 8,10 GET M->CHOICE PICTURE '9'
   READ
ENDDO

IF M->CHOICE = '3'
   CLEAR
   CLOSE DATABASES
   RETURN (NIL)
ENDIF

SET PRINTER TO C:\TEMP\W2G0720.TXT

m->printer_init := 'e(10u&l1o&l8d&l5e&l66f&k2s(s8v'

IF M->CHOICE = '1'
   SELECT 3
   GOTO TOP
   SET DEVICE TO PRINTER
   @ 0,0 say m->printer_init

   DO W2G0725
   DO WHILE .NOT. EOF()
      @ M->L_NUMBER, 01 SAY RPT0720->RECORD_ID
      @ M->L_NUMBER, 15 SAY RPT0720->BATCH_DATE
      @ M->L_NUMBER, 25 SAY RPT0720->BATCH_NUM  PICTURE '99'
      @ M->L_NUMBER, 30 SAY RPT0720->GROSS      PICTURE '999,999,999.99'
      @ M->L_NUMBER, 50 SAY RPT0720->FED_WITH   PICTURE '999,999,999.99'
      @ M->L_NUMBER, 70 SAY RPT0720->DATE_WON
      @ M->L_NUMBER, 80 SAY RPT0720->TRANS
      @ M->L_NUMBER, 95 SAY RPT0720->RACE       PICTURE '99'
      @ M->L_NUMBER,105 SAY RPT0720->WINNINGS
      @ M->L_NUMBER,117 SAY RPT0720->CASHIER    PICTURE '9999'
      @ M->L_NUMBER,125 SAY RPT0720->WINDOW     PICTURE '9999'
      M->L_NUMBER = M->L_NUMBER + 1
      IF M->L_NUMBER > 58
         DO W2G0725
      ENDIF
      SKIP
   ENDDO
   EJECT
   SET DEVICE TO SCREEN
   CLEAR
   CLOSE DATABASES
   RETURN (NIL)
ENDIF

@ 24,0 SAY "VERIFY THAT YOU WANT TO CREATE A NEW REPORT BY RE-ENTERING '2'."

M->CHOICE = ' '

DO WHILE .NOT. M->CHOICE $'123'
   M->CHOICE = ' '
   @ 8,10 GET M->CHOICE PICTURE '9'
   READ
ENDDO

IF M->CHOICE <> '2'
   CLEAR
   CLOSE DATABASES
   RETURN (NIL)
ENDIF
CLEAR

@ 1,20 SAY 'REPORT START TIME: '
M->TIME = TIME()
@ 1,39 SAY M->TIME
@ 3,20 SAY 'REBUILDING TICKET INDEXES. ONE MOMENT PLEASE.'

SELECT 1
PACK
GOTO TOP

@ 5,20 SAY 'REBUILDING PAYEE INDEXES. ONE MOMENT PLEASE.'

SELECT 2
PACK
GOTO TOP

SELECT 3
ZAP

SELECT 1

@ 07,20 SAY 'CREATING REPORT. ONE MOMENT PLEASE.'

DO WHILE .NOT. EOF()
   M->REC_ID = TICKET->RECORD_ID
   SELECT 2
   SEEK M->REC_ID
   IF EOF()
      SELECT 1
      M->REC_ID   = TICKET->RECORD_ID
      M->BTCH_DT  = TICKET->BATCH_DATE
      M->BTCH_NUM = TICKET->BATCH_NUM
      M->GROSS    = TICKET->GROSS
      M->FED_WITH = TICKET->FED_WITH
      M->DATE_WON = TICKET->DATE_WON
      M->TRANS    = TICKET->TRANS
      M->RACE     = TICKET->RACE
      M->WINNINGS = TICKET->WINNINGS
      M->CASHIER  = TICKET->CASHIER
      M->WINDOW   = TICKET->WINDOW
      DELETE
      SELECT 3
      APPEND BLANK
      REPLACE RPT0720->RECORD_ID  WITH M->REC_ID
      REPLACE RPT0720->BATCH_DATE WITH M->BTCH_DT
      REPLACE RPT0720->BATCH_NUM  WITH M->BTCH_NUM
      REPLACE RPT0720->GROSS      WITH M->GROSS
      REPLACE RPT0720->FED_WITH   WITH M->FED_WITH
      REPLACE RPT0720->DATE_WON   WITH M->DATE_WON
      REPLACE RPT0720->TRANS      WITH M->TRANS
      REPLACE RPT0720->RACE       WITH M->RACE
      REPLACE RPT0720->WINNINGS   WITH M->WINNINGS
      REPLACE RPT0720->CASHIER    WITH M->CASHIER
      REPLACE RPT0720->WINDOW     WITH M->WINDOW
      M->REC_ID   = SPACE(9)
      M->BTCH_DT  = DATE()
      M->BTCH_NUM = 0
      M->GROSS    = 0.00
      M->FED_WITH = 0.00
      M->DATE_WON = DATE()
      M->TRANS    = SPACE(10)
      M->RACE     = 0
      M->WINNINGS = SPACE(10)
      M->CASHIER  = 0
      M->WINDOW   = 0
   ENDIF
   SELECT 1
   SKIP
ENDDO

SELECT 3
GOTO TOP

SET DEVICE TO PRINTER

@ 0,0 say m->printer_init

DO W2G0725

DO WHILE .NOT. EOF()
   @ M->L_NUMBER, 01 SAY RPT0720->RECORD_ID
   @ M->L_NUMBER, 15 SAY RPT0720->BATCH_DATE
   @ M->L_NUMBER, 25 SAY RPT0720->BATCH_NUM  PICTURE '99'
   @ M->L_NUMBER, 30 SAY RPT0720->GROSS      PICTURE '999,999,999.99'
   @ M->L_NUMBER, 50 SAY RPT0720->FED_WITH   PICTURE '999,999,999.99'
   @ M->L_NUMBER, 70 SAY RPT0720->DATE_WON
   @ M->L_NUMBER, 80 SAY RPT0720->TRANS
   @ M->L_NUMBER, 95 SAY RPT0720->RACE       PICTURE '99'
   @ M->L_NUMBER,105 SAY RPT0720->WINNINGS
   @ M->L_NUMBER,117 SAY RPT0720->CASHIER    PICTURE '9999'
   @ M->L_NUMBER,125 SAY RPT0720->WINDOW     PICTURE '9999'
   M->L_NUMBER = M->L_NUMBER + 1
   IF M->L_NUMBER > 58
      DO W2G0725
   ENDIF
   SKIP
ENDDO

EJECT

SELECT 1
SET INDEX TO TICKET, BATCHID, BTCHDATE
PACK

SET DEVICE TO SCREEN

@  9,20 SAY 'REPORT COMPLETE.'
@ 11,20 SAY 'REPORT END TIME: '
M->TIME = TIME()
@ 11,37 SAY M->TIME

WAIT
CLOSE DATABASES
RETURN (NIL)
* EOF W2G0720.PRG